(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[8791],{3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return p},kt:function(){return m}});var r=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=r.createContext({}),c=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=c(e.components);return r.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,i=e.mdxType,a=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=c(n),m=i,f=d["".concat(l,".").concat(m)]||d[m]||u[m]||a;return n?r.createElement(f,o(o({ref:t},p),{},{components:n})):r.createElement(f,o({ref:t},p))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var a=n.length,o=new Array(a);o[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,o[1]=s;for(var c=2;c<a;c++)o[c]=n[c];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},1384:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return o},metadata:function(){return s},toc:function(){return l},default:function(){return p}});var r=n(2122),i=n(9756),a=(n(7294),n(3905)),o={},s={unversionedId:"examples/datamodule-example",id:"examples/datamodule-example",isDocsHomePage:!1,title:"Data interface single and multi process",description:"This is an example explaining how to leverage the in-built multiprocessing capability of DataInterface for large amounts of data.",source:"@site/docs/examples/datamodule-example.md",sourceDirName:"examples",slug:"/examples/datamodule-example",permalink:"/PyMarlin/docs/examples/datamodule-example",editUrl:"https://github.com/microsoft/PyMarlin/edit/master/website/docs/examples/datamodule-example.md",version:"current",frontMatter:{},sidebar:"docsSidebar",previous:{title:"CIFAR image classification",permalink:"/PyMarlin/docs/examples/cifar"},next:{title:"Distillation",permalink:"/PyMarlin/docs/examples/distillation"}},l=[{value:"Configs - YAML and Parsing",id:"configs---yaml-and-parsing",children:[]},{value:"Virtual machine",id:"virtual-machine",children:[{value:"Single virtual machine with multi process",id:"single-virtual-machine-with-multi-process",children:[]},{value:"Selective node preprocessing",id:"selective-node-preprocessing",children:[]},{value:"AML",id:"aml",children:[]}]}],c={toc:l};function p(e){var t=e.components,n=(0,i.Z)(e,["components"]);return(0,a.kt)("wrapper",(0,r.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"This is an example explaining how to leverage the in-built multiprocessing capability of DataInterface for large amounts of data.\nFor example purpose we are using 27 files from wikipedia raw text.\n1) Azure virtual machine , single node multi-process , single selective machine\n2) AML, single node vs multi-node, single selective machine"),(0,a.kt)("h2",{id:"configs---yaml-and-parsing"},"Configs - YAML and Parsing"),(0,a.kt)("p",null,"For ease of use we have configs passed in as YAML files.\nIn this case we use the config file : config_prod.yaml included with example code."),(0,a.kt)("p",null,"Snippet of config: ( modify file paths according to your folder structure)"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},"input_dir: 'C:/Users/ashwinsr/wikipedia.part1'\nout_dir: 'C:/Users/ashwinsr/out_fold'\nprocess_count: 10\nrun_type: ''\n")),(0,a.kt)("p",null,"This config can be read in like below : "),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},"#Create arg parser and read config\nparser = CustomArgParser(log_level='DEBUG', default_yamlfile=\"config_prod.yaml\")\nconfig = parser.parse()\n")),(0,a.kt)("p",null,"Our data processor is a simple token splitter which given raw text will split it into token store the results back in a file. The processor runs 1 file at a time."),(0,a.kt)("h2",{id:"virtual-machine"},"Virtual machine"),(0,a.kt)("h3",{id:"single-virtual-machine-with-multi-process"},"Single virtual machine with multi process"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},'dataInterface = Ex_dataInterface()  \nfile_list = dataInterface.get_file_names(config["input_dir"])\n#create and run processor1\nexample_processor = Processor1(config["input_dir"], config["out_dir"])\nout = example_processor.multi_process_data(file_list, process_count=config["process_count"])\n')),(0,a.kt)("p",null,"Here we create a list of files in the directory and initialize the processor with the input and output directory. We call the the multi_process_data function in the processor, passing the list of files , with the process count. The processor then spins up those many number of processes to create coressponding output. "),(0,a.kt)("h3",{id:"selective-node-preprocessing"},"Selective node preprocessing"),(0,a.kt)("p",null,"For a case where we have a single node but want to process the data in batches. We want the processor to run on different subset of files depending upon the rank we assign. This is to emulate multi-node behaviour with a single node by controlling the node rank parameter."),(0,a.kt)("p",null,"For instance if we have 30 files to process over 5 separate runs , then we need to add the following to config and initialize dataProcessor accordingly"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},"distribArgs:\n    local_rank:  0\n    global_rank:  0\n    world_size:  1\n    node_count:  5\n    local_size:  1\n    node_rank: 3\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},'distrib = DistributedPreprocessArguments(**config["distribArgs"])\nexample_processorer = Processor1(config["input_dir"], config["out_dir"], distrib)\n')),(0,a.kt)("p",null,"Remember to initialize the base dataProcessor class with the distributed arguemnts as shown below, the default None would treat it like a regular multi-node processing job"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"class Processor1(data_interface.DataProcessor):\n    def __init__(self, input_dir, out_dir, distrib_args = None):\n        super(Processor1, self).__init__(distrib_args)\n        self.input_dir = input_dir\n        self.out_dir = out_dir\n")),(0,a.kt)("p",null,"With the above setting we would process files 18-24 out of 30. Since the node_rank is 3 (0 indexed) and can be a maximum of 4. node_count gives us a count of total nodes available\nThis gives a flexibility with large data processing with limited compute."),(0,a.kt)("p",null,"To run in virtual machine copy over the files to virtual machine using SCP\nInstall pymarlin and requirements and run example"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},"    > ssh $user@$machine -p $port\n    $ pip install  ./pymarlin --force-reinstall\n    $ pip install -r pymarlin/requirements.txt\n    $ cd data_ex\n    $ python data.py\n")),(0,a.kt)("h3",{id:"aml"},"AML"),(0,a.kt)("p",null,"We can do single and multi-node processing both with AML. The datamodule handles AML ranking internally for both single and multinodes to appropriately divide the files across nodes.\nYou will find a notebook along with the example to submit a AML a job, with placeholders for storage and compute accounts."))}p.isMDXComponent=!0}}]);