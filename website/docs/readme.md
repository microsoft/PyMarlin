## Webapp

- We use sphinx to generate our documentation
- We use Azure webapps to host it

### Contribution

Most of the process is automated by CI/CD pipeline:

- Build docstrings
- Builds the html files

There are a few things to understand how to contribute.

#### The layout

```
webapp/
    index.rst  # this is the master table of contents
    conf.py  # configuration for sphinx
    source/  # directory where docstring files are automatically generated by sphinx
    example.md  # markdown or rst files can be included here
    ...  # other files can largely be ignored
```

#### How to add a new file
    
1. Create a new file e.g. `webapp/example.md` (You can also use `.rst` if you like)
2. Add this to the `index.rst` file

    You can add it to an existing section, or create a new one.

    ```rst
    .. toctree::
        :maxdepth: 1
        :caption: New Section

        example
    ```
3. (Optional) Test your changes locally.

    - Set up a python environment as follows:

        ```bash
        conda create --name pymarlin-sphinx python=3.8
        conda activate pymarlin-sphinx
        pip install -r requirements.txt  # pymarlin requirements
        pip install -r docs/webapp/requirements.txt  # sphinx requirements
        ```
    
    - To test your changes locally run `make html`:
        ```bash
        cd webapp
        make html
        ```
        This will update the html files in `webapp/_build/html`. You can open these
        files in your browser to observe the changes / behavior.
4. Push your changes to master branch - the build pipeline will take care of the
    rest, i.e., it will push the changes to the webapp.

#### Adding nested pages

If you want to add multiple pages under a single section in the docs that is
possible.

For example, in the `index.rst` file we declare a section `Scenarios`. Suppose
you want to add a new scenario `BART` with multiple subpages:

- bart1.md
- bart2.md

To do this create a page `bart-index.rst` as follows:

```rst
BART Scenario

.. toctree::
   :maxdepth: 1
   :caption: BART Scenario:

   bart1
   bart2
```

Then add this to the `index.rst` file, e.g.:

```
.. toctree::
   :maxdepth: 1
   :caption: Scenarios

   scenarios
   bart-index
```

### Setup

This describes how this was setup.

Run quickstart to generate sphinx project scaffolding:

```bash
cd docs/webapp
sphinx-quickstart
```

This will create `conf.py` and `index.rst` (among other things).

Update `conf.py` with the following:

```python
import os
import sys
PATH_HERE = os.path.abspath(os.path.dirname(__file__))
PATH_ROOT = os.path.join(PATH_HERE, '..', '..')
sys.path.insert(0, os.path.abspath(PATH_ROOT))

extensions = [
    'sphinx.ext.napoleon',
    'sphinx.ext.autodoc',
    ... # added a bunch of extensions
]

napoleon_google_docstring = True

html_theme = 'sphinx_rtd_theme'
```

Update the `index.rst` file to have the desired layout for the homepage.

Now to generate the documentation run

```
cd webapp
sphinx-apidoc -o source ../../pymarlin
```

This will scan `../../pymarlin` for python modules and put their docstrings
in `docs/webapp/source`. You can see a bunch of `.rst` files in there now.

To build the html files manually you run

```
make html
```

This creates the html files in `docs/webapp/_build/html`.

Finally, to manually push these files to the azure webapp:

```
cd _build/html
az webapp up --name pymarlin-docs --html
```

Note: Very rarely the `az webapp up` command might fail transiently - just re-run.