<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.75">
<link rel="alternate" type="application/rss+xml" href="/PyMarlin/blog/rss.xml" title="PyMarlin Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/PyMarlin/blog/atom.xml" title="PyMarlin Blog Atom Feed"><title data-react-helmet="true">Named Entity Recognition with HuggingFace models | PyMarlin</title><meta data-react-helmet="true" property="og:url" content="https://github.com/microsoft/PyMarlin/PyMarlin/docs/plugins/hf_ner"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Named Entity Recognition with HuggingFace models | PyMarlin"><meta data-react-helmet="true" name="description" content="We designed this plugin to allow for out-of-the-box training and evaluation of HuggingFace models for NER tasks. We provide a golden config file (config.yaml) which you can adapt to your task. This config will make experimentations easier to schedule and track. All the source code and notebooks to submit jobs can be found here"><meta data-react-helmet="true" property="og:description" content="We designed this plugin to allow for out-of-the-box training and evaluation of HuggingFace models for NER tasks. We provide a golden config file (config.yaml) which you can adapt to your task. This config will make experimentations easier to schedule and track. All the source code and notebooks to submit jobs can be found here"><link data-react-helmet="true" rel="shortcut icon" href="/PyMarlin/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://github.com/microsoft/PyMarlin/PyMarlin/docs/plugins/hf_ner"><link data-react-helmet="true" rel="alternate" href="https://github.com/microsoft/PyMarlin/PyMarlin/docs/plugins/hf_ner" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://github.com/microsoft/PyMarlin/PyMarlin/docs/plugins/hf_ner" hreflang="x-default"><link rel="stylesheet" href="/PyMarlin/assets/css/styles.4339f032.css">
<link rel="preload" href="/PyMarlin/assets/js/runtime~main.71165dba.js" as="script">
<link rel="preload" href="/PyMarlin/assets/js/main.3e2fd774.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/PyMarlin/"><img src="/PyMarlin/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/PyMarlin/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">PyMarlin</strong></a><a class="navbar__item navbar__link navbar__link--active" href="/PyMarlin/docs/getting-started">Docs</a><a class="navbar__item navbar__link" href="/PyMarlin/docs/reference/core/module_interface">SDK</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/microsoft/PyMarlin" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/PyMarlin/"><img src="/PyMarlin/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/PyMarlin/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">PyMarlin</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link navbar__link--active" href="/PyMarlin/docs/getting-started">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/PyMarlin/docs/reference/core/module_interface">SDK</a></li><li class="menu__list-item"><a href="https://github.com/microsoft/PyMarlin" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/PyMarlin/docs/getting-started">Getting Started</a></li><li class="menu__list-item"><a class="menu__link" href="/PyMarlin/docs/installation">Installation</a></li><li class="menu__list-item"><a class="menu__link" href="/PyMarlin/docs/marlin-in-pictures">PyMarlin in Pictures</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Examples</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/PyMarlin/docs/examples/cifar">CIFAR image classification</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/PyMarlin/docs/examples/classification">Covid-19 Classification</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/PyMarlin/docs/examples/datamodule-example">Data interface single and multi process</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/PyMarlin/docs/examples/distillation">Distillation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/PyMarlin/docs/examples/glue-tasks">Glue Tasks</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/PyMarlin/docs/examples/summarization">CNN/DailyMail Summarization</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Plugins</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/PyMarlin/docs/plugins/hf_ner">Named Entity Recognition with HuggingFace models</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/PyMarlin/docs/plugins/hf_seq_classification">Text Sequence Classification with Huggingface models</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/PyMarlin/docs/utils/stats">Stats and Tensorboard logging</a></li><li class="menu__list-item"><a class="menu__link" href="/PyMarlin/docs/contributing">Contribution and Feedback</a></li></ul></div></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">Named Entity Recognition with HuggingFace models</h1></header><div class="markdown"><p>We designed this plugin to allow for out-of-the-box training and evaluation of HuggingFace models for NER tasks. We provide a golden config file (config.yaml) which you can adapt to your task. This config will make experimentations easier to schedule and track. All the source code and notebooks to submit jobs can be found <a href="https://o365exchange.visualstudio.com/O365%20Core/_git/ELR?path=%2Fsources%2Fdev%2FSubstrateInferences%2FMarlin_Scenarios%2Fner%2Ftest_nerPlugin" target="_blank" rel="noopener noreferrer">here</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="step-by-step-with-germeval-dataset"></a>Step by step with GermEval dataset<a class="hash-link" href="#step-by-step-with-germeval-dataset" title="Direct link to heading">#</a></h2><p>We will go through how to adapt any dataset/task for PyMarlin and how to setup the plugin. For this purpose we will use the GermEval dataset - this is a dataset with German Named Entity annotation , with data sampled from German Wikipedia and News Corpora. For more granular information and raw dataset please refer <a href="https://sites.google.com/site/germeval2014ner/data" target="_blank" rel="noopener noreferrer">here</a></p><p>Following HuggingFace documentation for preliminary data clean up we use their preprocess script to clean up the original dataset. These can be run in jupyter Notebook.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><div tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">!wget </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;https://raw.githubusercontent.com/stefan-it/fine-tuned-berts-seq/master/scripts/preprocess.py&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">!grep </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">v </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;^#&quot;</span><span class="token plain"> NER</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">de</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">train</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">tsv</span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> cut </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">f </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">3</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> tr </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;\t&#x27;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27; &#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> train</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">txt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">tmp</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">!grep </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">v </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;^#&quot;</span><span class="token plain"> NER</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">de</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">dev</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">tsv</span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> cut </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">f </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">3</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> tr </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;\t&#x27;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27; &#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> dev</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">txt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">tmp</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">!python preprocess</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">py train</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">txt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">tmp </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;bert-base-multilingual-cased&#x27;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;128&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> train</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">txt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">!python preprocess</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">py dev</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">txt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">tmp </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;bert-base-multilingual-cased&#x27;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;128&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> dev</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">txt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">!cat train</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">txt dev</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">txt </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> cut </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">d </span><span class="token string" style="color:rgb(195, 232, 141)">&quot; &quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">f </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> grep </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">v </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;^$&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> sort </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> uniq </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">txt</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="dataset-format"></a>Dataset format<a class="hash-link" href="#dataset-format" title="Direct link to heading">#</a></h2><p>NER plugin expects the input to be a TSV or CSV with 2 columns. A column with the text sentences followed by a column with the labels for the tokens in the sentence. For example: &#x27;Sentence&#x27;: &#x27;who is harry&#x27;, &#x27;Slot&#x27;: &#x27;O O B-contact_name&#x27;</p><p>For GermEval dataset below we show how to modify to format expected by plugin.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><div tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> csv</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">txt2tsv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">filename</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> outfile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  outfile </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">open</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">outfile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;w&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  f </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">open</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">filename</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;r&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  lines </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> f</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">readlines</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  sentence </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  labels </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  tsv_writer </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> csv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">writer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">outfile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> delimiter</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;\t&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  tsv_writer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">writerow</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Sentence&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Slot&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> line </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> lines</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    line </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> line</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">strip</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> line</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      row </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> line</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">split</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27; &#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      sentence</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">row</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">row</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">else</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      sent </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27; &#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">join</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sentence</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      lab </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27; &#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">join</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      tsv_writer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">writerow</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">sent</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> lab</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      sentence </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      labels </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">txt2tsv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;dev.txt&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;dev.tsv&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">txt2tsv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;train.txt&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;train.tsv&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The dataset would now look like this:</p><p><img alt="Dataset" src="/PyMarlin/assets/images/ner_dataset_mod-0d65e2c633fe9b03129eb61780e1fa6c.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="golden-yaml-config"></a>Golden yaml config<a class="hash-link" href="#golden-yaml-config" title="Direct link to heading">#</a></h2><p>Marlin leverages yaml files for maintaining experiment parameters. For this German Evaluation dataset we provide a golden config <code>config_germ.yaml</code>. </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><div tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># data_processor args</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    train_dir </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    val_dir </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    labels_list</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">B</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">LOC</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> B</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">LOCderiv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> B</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">LOCpart</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> B</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">ORG</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> B</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">ORGderiv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> B</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">ORGpart</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> B</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">OTH</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> B</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">OTHderiv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        B</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">OTHpart</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> B</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">PER</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> B</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">PERderiv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> B</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">PERpart</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> I</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">LOC</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> I</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">LOCderiv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> I</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">LOCpart</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> I</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">ORG</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> I</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">ORGderiv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        I</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">ORGpart</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> I</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">OTH</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> I</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">OTHderiv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> I</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">OTHpart</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> I</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">PER</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> I</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">PERderiv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> I</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">PERpart</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> O</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    tokenizer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;bert-base-multilingual-cased&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    file_format</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;tsv&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    has_labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">True</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># model arguments</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">model</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    model_name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;bert&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    encoder_key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;bert&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    hf_model</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;bert-base-multilingual-cased&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    model_file</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;pytorch_model.bin&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    model_config_file</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;config.json&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    model_path</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    model_config_path</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># module_interface arguments</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">module</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    output_dir</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    max_lr </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0.00003</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Maximum learning rate.</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    warmup_prop</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0.1</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    max_seq_len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">128</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pad_label_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">100</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    has_labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">True</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># trainer arguments</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">trainer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    backend</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;sp&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    train_batch_size</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">32</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Training global batch size.</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    val_batch_size</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">16</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Validation global batch size.</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    epochs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">25</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Total epochs to run.</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    gpu_batch_size_limit </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">8</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Max limit for GPU batch size during training.</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    clip_grads </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">True</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Enable or disable clipping of gradients.</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    use_gpu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">True</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Enable or disable use of GPU.</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    max_grad_norm</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1.0</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Maximum value for gradient norm.</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    writers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;stdout&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;aml&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;tensorboard&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># List of all the writers to use.</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    disable_tqdm</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">True</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    log_level</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;DEBUG&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="training"></a>Training<a class="hash-link" href="#training" title="Direct link to heading">#</a></h2><p>Next we need a orchestrating script to initialize the plugin and start training. Assume the script test.py. It will contain the following.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><div tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> pymarlin</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">plugins </span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> HfNERPlugin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">plugin </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> HfNERPlugin</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">plugin</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">setup_trainer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">trainer </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> plugin</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">trainer</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">trainer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">train</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">trainer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">validate</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>We can now schedule a run locally using CLI , modify to point to the train and validation directory appropriately :</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><div tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">python test</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">py </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">train_filepath </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">train_germ</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">train</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">tsv </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">val_filepath </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">val_germ</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">dev</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">tsv </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">config_path config_germ</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">yaml</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="evaluation"></a>Evaluation<a class="hash-link" href="#evaluation" title="Direct link to heading">#</a></h2><p>We specify the path to store the model checkpoints in our config.yaml</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Checkpointer arguments</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ckpt:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    checkpoint: True # Flag indicating whether to checkpoint model.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    delete_existing_checkpoints: True</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    period: 1 # Period of epochs at which to checkpoint model.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    save_dir: &#x27;ckpts&#x27; # Path to directory where MARLIN checkpoints are to be stored.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    model_save_dir: &#x27;model_ckpts&#x27; # Path to directory where MODEL checkpoints are to be stored</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    file_prefix: &#x27;marlin&#x27; # Prefix of the checkpoint filename.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    file_ext: &#x27;bin&#x27; # File extension for the checkpoint.</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The checkpoint consists of all the different components of your scenario like &#x27;module_interface_state&#x27;, &#x27;trainer_state&#x27; and &#x27;trainer_backend_state&#x27;. We need to save the model from within the &#x27;module_interface_state&#x27; separately. Follow the below steps included in the notebook &#x27;GermEvalAML.ipynb&#x27; <a href="https://o365exchange.visualstudio.com/O365%20Core/_git/ELR?path=%2Fsources%2Fdev%2FSubstrateInferences%2FMarlin_Scenarios%2Fner%2Fnotebooks%2FGermEvalAML.ipynb" target="_blank" rel="noopener noreferrer">here</a></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">import torch</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">from collections import OrderedDict</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">state_dict = torch.load(&#x27;marlin_0.bin&#x27;, map_location=&#x27;cpu&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">new_dict = OrderedDict((key.replace(&#x27;model.&#x27;,&#x27;&#x27;), value) for key, value in state_dict[&#x27;module_interface_state&#x27;].items() if key.startswith(&#x27;model.&#x27;) )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">torch.save(new_dict, &#x27;marlin_model.bin&#x27;)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Alternatively you could directly load only the model checkpoint as stored in the path specified by <code>model_save_dir</code>. In this case you would have the model weights directly in state_dict without needing to go through module_interface_state</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">import torch</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">from collections import OrderedDict</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">state_dict = torch.load(&#x27;marlin_0.bin&#x27;, map_location=&#x27;cpu&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">new_dict = OrderedDict((key.replace(&#x27;model.&#x27;,&#x27;&#x27;), value) for key, value in state_dict.items() if key.startswith(&#x27;model.&#x27;) )  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">torch.save(new_dict, &#x27;marlin_model.bin&#x27;)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Now you can use the model file stored as marlin_model.bin. You can specify this new model as the checkpoint to start from in config.yaml</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># model arguments</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">model:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    model_name: &quot;bert&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    encoder_key: &quot;bert&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    hf_model: &quot;bert-base-multilingual-cased&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    model_file: &quot;pytorch_model.bin&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    model_config_file: &quot;config.json&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    model_path: &quot;&lt;directory containing ckpt&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    model_config_path: &quot;marlin_model.bin&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>You can use NER Plugin to evaluate:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">from marlin.plugins import HfNERPlugin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">plugin = HfNERPlugin()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">plugin.setup_trainer()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">trainer = plugin.trainer</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">trainer.train()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">trainer.validate()</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/microsoft/PyMarlin/edit/master/website/docs/plugins/hf_ner.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/PyMarlin/docs/examples/summarization"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« CNN/DailyMail Summarization</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/PyMarlin/docs/plugins/hf_seq_classification"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Text Sequence Classification with Huggingface models Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#step-by-step-with-germeval-dataset" class="table-of-contents__link">Step by step with GermEval dataset</a></li><li><a href="#dataset-format" class="table-of-contents__link">Dataset format</a></li><li><a href="#golden-yaml-config" class="table-of-contents__link">Golden yaml config</a></li><li><a href="#training" class="table-of-contents__link">Training</a></li><li><a href="#evaluation" class="table-of-contents__link">Evaluation</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/PyMarlin/docs/getting-started">Getting Started</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/pymarlin" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/microsoft/PyMarlin" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Microsoft Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/PyMarlin/assets/js/runtime~main.71165dba.js"></script>
<script src="/PyMarlin/assets/js/main.3e2fd774.js"></script>
</body>
</html>